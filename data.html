<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kaiserpunk Production Chain Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 2em;
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 0;
      text-align: center;
    }
    h1 a { color: inherit; text-decoration: none; }
    h1 a:hover, h1 a:focus { text-decoration: underline; }
    h3 { margin-bottom: 0.5em; margin-top: 0; }
    select, input[type="number"] { padding: 0.5em; margin: 0 0.5em 0.5em 0; min-width: 100px; border: 1px solid #ccc; border-radius: 4px; vertical-align: middle; }
    input[type="number"] { width: 80px; }
    .controls, #buildingUpgrades, .output, #graphContainer, #totalsDiv, #externalInputsDiv { background: #eee; padding: 1em; border-radius: 8px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); width: 100%; box-sizing: border-box; }
    .output, #graphContainer, #totalsDiv, #externalInputsDiv { background: white; }
    .output div, .output ul, #totalsDiv ul, #externalInputsDiv ul { margin: 0.5em 0; }
    .label { font-weight: bold; margin-bottom: 0.3em; display: block; }
    ul { padding-left: 1.5em; margin-top: 0.2em; margin-bottom: 1em; list-style: disc; }
    li { margin-bottom: 0.3em; }
    .controls label { display: block; margin-bottom: 0.3em; font-weight: bold; }
    .controls label[for="amount"] { margin-top: 0.8em; }
    .controls select, .controls input[type="number"] { display: inline-block; margin-left: 0; margin-bottom: 0.5em; max-width: 300px; }
    .main-container { display: flex; flex-direction: row; gap: 1.5em; align-items: flex-start; margin-top: 1em; }
    .left-column { flex: 0 0 520px; display: flex; flex-direction: column; gap: 1.5em; }
    .center-column { flex: 3; display: flex; flex-direction: column; gap: 1.5em; min-width: 0; }
    .right-column { flex: 2; display: flex; flex-direction: column; gap: 1.5em; min-width: 0; }
    #buildingUpgrades { background: #f8f8f8; }
    .upgrade-row { display: flex; align-items: center; margin-bottom: 0.5em; gap: 5px; justify-content: space-between; }
    .upgrade-row label { flex: 0 1 180px; margin-right: 10px; width: auto; margin-bottom: 0; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
    .upgrade-row select { flex: 1 1 90px; min-width: 90px; margin-right: 0; margin-bottom: 0; font-size: 0.85em; }
    #totalsDiv, #externalInputsDiv {}
    #totalsDiv ul, #externalInputsDiv ul { margin-top: 0.2em; margin-bottom: 0.5em; padding-left: 1.5em; }
    #totalsDiv li, #externalInputsDiv li { margin-bottom: 0.3em; }
    .output { margin: 0; }
     #graphContainer { flex-grow: 1; padding: 1em; min-height: 400px; display: flex; flex-direction: column; background: white; border-radius: 8px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); width: 100%; box-sizing: border-box; }
    #graphDiv { flex-grow: 1; overflow: auto; background: #fdfdfd; border: 1px solid #eee; border-radius: 4px; padding: 0.5em; display: flex; justify-content: center; align-items: center; min-height: 300px; }
    .mermaid svg { max-width: 100%; height: auto; display: block; margin: 0 auto; }
    .highlight-recipe { border: 1px solid #a0c0e0; background-color: #f0f8ff; padding: 0.8em; margin-bottom: 1.5em !important; border-radius: 6px; }
    .highlight-recipe .label { color: #0056b3; }
    .highlight-recipe ul { margin-top: 0.3em; margin-bottom: 0.5em; }
    @media (max-width: 1300px) {
        .main-container { flex-direction: column; gap: 1.5em; }
        .left-column, .center-column, .right-column { flex: 1 1 auto; width: 100%; min-width: 0; max-width: none; }
        .left-column { position: static; flex-basis: auto; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
  <h1> <a href="https://store.steampowered.com/app/2012190/KAISERPUNK/" target="_blank">Kaiserpunk</a> Production Chain Calculator</h1>

  <!-- Main Container for Flexbox -->
  <div class="main-container">
    <!-- Left Column: Controls, Upgrades, Totals, Inputs -->
    <div class="left-column">
      <div class="controls">
        <label for="productSelector">Select Product:</label>
        <select id="productSelector"></select>
        <label for="amount">Target Output per Cycle:</label>
        <input type="number" id="amount" value="1" min="1" step="1" />
      </div>
      <div id="buildingUpgrades"></div>
      <div id="totalsDiv"></div>
      <div id="externalInputsDiv"></div>
    </div>
    <!-- Center Column: Recipe, Steps, Buildings -->
    <div class="center-column">
      <div class="output" id="outputDetails">Loading...</div>
    </div>
    <!-- Right Column: Graph ONLY -->
    <div class="right-column">
      <div id="graphContainer">
          <div class="label">Production Flow Visualizer:</div>
          <div class="mermaid" id="graphDiv">
              <p style="text-align: center; color: #888; margin-top: 2em;">Select a product to view visualization.</p>
          </div>
      </div>
    </div>
  </div><!-- End of main-container -->

  <script>
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
    // --- DATA DEFINITIONS (data, buildings) ---
    const data = { /* ... Your data ... */
      "Fish": { output: 10, cycle: 12, inputs: null, base: { "Fish": 1 } },
      "Grain": { output: 10, cycle: 12, inputs: null, base: { "Grain": 1 } },
      "Flour": { output: 8, cycle: 12, inputs: { "Grain": 5 }, base: { "Grain": 0.625 } },
      "Bread": { output: 10, cycle: 12, inputs: { "Flour": 3 }, base: { "Grain": 0.1875 } },
      "Wood": { output: 16, cycle: 12, inputs: null, base: { "Wood": 1 } },
      "Plywood": { output: 10, cycle: 12, inputs: { "Wood": 4 }, base: { "Wood": 0.4 } },
      "Lumber": { output: 12, cycle: 12, inputs: { "Wood": 2 }, base: { "Wood": 0.1667 } },
      "Cellulose": { output: 20, cycle: 12, inputs: { "Wood": 4 }, base: { "Wood": 0.2 } },
      "Iron": { output: 10, cycle: 12, inputs: null, base: { "Iron": 1 } },
      "Coal": { output: 10, cycle: 12, inputs: null, base: { "Coal": 1 } },
      "Steel": { output: 20, cycle: 12, inputs: { "Iron": 7, "Coal": 7 }, base: { "Coal": 0.35, "Iron": 0.35 } },
      "Cotton": { output: 10, cycle: 12, inputs: null, base: { "Cotton": 1 } },
      "Cloth": { output: 20, cycle: 12, inputs: { "Cotton": 5 }, base: { "Cotton": 0.25 } },
      "Clothes": { output: 5, cycle: 12, inputs: { "Cloth": 3 }, base: { "Cotton": 0.15 } },
      "Copper": { output: 16, cycle: 12, inputs: null, base: { "Copper": 1 } },
      "Zinc": { output: 7, cycle: 12, inputs: null, base: { "Zinc": 1 } },
      "Brass": { output: 15, cycle: 12, inputs: { "Copper": 3, "Zinc": 5 }, base: { "Copper": 0.2, "Zinc": 0.3333 } },
      "Vegetables": { output: 10, cycle: 12, inputs: null, base: { "Vegetables": 1 } },
      "FoodRations": { output: 8, cycle: 12, inputs: { "Bread": 4, "Vegetables": 4 }, base: { "Grain": 0.0938, "Vegetables": 0.5 } },
      "Gramophone": { output: 5, cycle: 12, inputs: { "Lumber": 4, "Copper": 3 }, base: { "Copper": 0.6, "Wood": 0.1333 } },
      "Ammunition": { output: 10, cycle: 12, inputs: { "Cellulose": 5, "Brass": 3 }, base: { "Copper": 0.06, "Wood": 0.1, "Zinc": 0.1 } },
      "Handguns": { output: 6, cycle: 12, inputs: { "Lumber": 5, "Steel": 1 }, base: { "Coal": 0.0583, "Iron": 0.0583, "Wood": 0.1389 } },
      "FieldGun": { output: 1, cycle: 4, inputs: { "Steel": 6 }, base: { "Coal": 2.1, "Iron": 2.1 } },
      "InfantryTank": { output: 1, cycle: 6, inputs: { "Steel": 10 }, base: { "Coal": 3.5, "Iron": 3.5 } },
      "Corvette": { output: 1, cycle: 48, inputs: { "Steel": 40 }, base: { "Coal": 14, "Iron": 14 } },
      "ReconBiplane": { output: 1, cycle: 6, inputs: { "Cloth": 10, "Lumber": 10 }, base: { "Cotton": 2.5, "Wood": 1.6667 } },
      "Blimp": { output: 1, cycle: 12, inputs: { "Cloth": 20, "Lumber": 20 }, base: { "Cotton": 5, "Wood": 3.3333 } },
      "Clay": { output: 10, cycle: 12, inputs: null, base: { "Clay": 1 } },
      "Bricks": { output: 10, cycle: 12, inputs: { "Clay": 4, "Coal": 2 }, base: { "Clay": 0.4, "Coal": 0.2 } },
      "Paper": { output: 10, cycle: 12, inputs: { "Cellulose": 12 }, base: { "Wood": 0.24 } },
      "Newspapers": { output: 5, cycle: 12, inputs: { "Paper": 5 }, base: { "Wood": 0.24 } },
      "CrudeOil": { output: 20, cycle: 12, inputs: null, base: { "CrudeOil": 1 } },
      "Diesel": { output: 8, cycle: 12, inputs: { "CrudeOil": 3 }, base: { "CrudeOil": 0.375 } },
      "Rubber": { output: 20, cycle: 12, inputs: { "CrudeOil": 3 }, base: { "CrudeOil": 0.15 } },
      "Chemicals": { output: 18, cycle: 12, inputs: { "CrudeOil": 3 }, base: { "CrudeOil": 0.1667 } },
      "Ale": { output: 6, cycle: 12, inputs: { "Grain": 5 }, base: { "Grain": 0.8333 } },
      "Meat": { output: 8, cycle: 12, inputs: null, base: { "Meat": 1 } },
      "Galena": { output: 10, cycle: 12, inputs: null, base: { "Galena": 1 } },
      "Lead": { output: 10, cycle: 12, inputs: { "Galena": 5 }, base: { "Galena": 0.5 } },
      "Silver": { output: 6, cycle: 12, inputs: { "Galena": 5 }, base: { "Galena": 0.8333 } },
      "Radio": { output: 4, cycle: 12, inputs: { "Rubber": 3, "Copper": 3 }, base: { "Copper": 0.75, "CrudeOil": 0.1125 } },
      "ArtilleryShells": { output: 8, cycle: 12, inputs: { "Lead": 10, "Chemicals": 5 }, base: { "CrudeOil": 0.1042, "Galena": 0.625 } },
      "Rifles": { output: 4, cycle: 12, inputs: { "Steel": 7, "Rubber": 7 }, base: { "Coal": 0.6125, "CrudeOil": 0.2625, "Iron": 0.6125 } },
      "PounderGun": { output: 1, cycle: 4, inputs: { "Steel": 7, "Brass": 10 }, base: { "Coal": 2.45, "Copper": 2, "Iron": 2.45, "Zinc": 3.3333 } },
      "LightTank": { output: 1, cycle: 6, inputs: { "Steel": 10, "Rubber": 10 }, base: { "Coal": 3.5, "CrudeOil": 1.5, "Iron": 3.5 } },
      "Destroyer": { output: 1, cycle: 52, inputs: { "Steel": 60, "Lumber": 40 }, base: { "Coal": 21, "Iron": 21, "Wood": 6.6667 } },
      "FighterTriplane": { output: 1, cycle: 8, inputs: { "Steel": 10, "Lumber": 10 }, base: { "Coal": 3.5, "Iron": 3.5, "Wood": 1.6667 } },
      "Airship": { output: 1, cycle: 15, inputs: { "Steel": 15, "Lumber": 20, "Cellulose": 10 }, base: { "Coal": 5.25, "Iron": 5.25, "Wood": 5.3333 } },
      "FishSoup": { output: 8, cycle: 12, inputs: { "Fish": 5, "Vegetables": 5 }, base: { "Fish": 0.625, "Vegetables": 0.625 } },
      "Fruit": { output: 15, cycle: 12, inputs: null, base: { "Fruit": 1 } },
      "Juice": { output: 8, cycle: 12, inputs: { "Fruit": 10 }, base: { "Fruit": 1.25 } },
      "Limestone": { output: 8, cycle: 12, inputs: null, base: { "Limestone": 1 } },
      "Gravel": { output: 9, cycle: 12, inputs: null, base: { "Gravel": 1 } },
      "Cement": { output: 9, cycle: 12, inputs: { "Limestone": 4 }, base: { "Limestone": 0.4444 } },
      "Concrete": { output: 7, cycle: 12, inputs: { "Cement": 3, "Gravel": 6 }, base: { "Gravel": 0.8571, "Limestone": 0.1905 } },
      "Plastics": { output: 15, cycle: 12, inputs: { "CrudeOil": 5, "Cellulose": 20 }, base: { "CrudeOil": 0.3333, "Wood": 0.2667 } },
      "Telephone": { output: 4, cycle: 12, inputs: { "Plastics": 3, "Copper": 2 }, base: { "Copper": 0.5, "CrudeOil": 0.25, "Wood": 0.2 } },
      "Silk": { output: 8, cycle: 12, inputs: null, base: { "Silk": 1 } },
      "Dye": { output: 5, cycle: 12, inputs: { "Chemicals": 3 }, base: { "CrudeOil": 0.1 } },
      "SilkCloth": { output: 5, cycle: 12, inputs: { "Silk": 5, "Dye": 3 }, base: { "CrudeOil": 0.06, "Silk": 1 } },
      "FineGarments": { output: 5, cycle: 12, inputs: { "SilkCloth": 3 }, base: { "CrudeOil": 0.036, "Silk": 0.6 } },
      "Aluminum": { output: 8, cycle: 12, inputs: null, base: { "Aluminum": 1 } },
      "NaturalGas": { output: 16, cycle: 12, inputs: { "CrudeOil": 4 }, base: { "CrudeOil": 0.25 } },
      "AluminumSheets": { output: 15, cycle: 12, inputs: { "Aluminum": 6, "NaturalGas": 4 }, base: { "Aluminum": 0.4, "CrudeOil": 0.0667 } },
      "CannedMeat": { output: 6, cycle: 12, inputs: { "Meat": 5, "AluminumSheets": 3 }, base: { "Aluminum": 0.2, "CrudeOil": 0.0333, "Meat": 0.8333 } },
      "ArmyRations": { output: 6, cycle: 12, inputs: { "Bread": 5, "CannedMeat": 5 }, base: { "Aluminum": 0.1667, "CrudeOil": 0.0278, "Grain": 0.1562, "Meat": 0.6944 } },
      "Kerosene": { output: 4, cycle: 12, inputs: { "CrudeOil": 2, "Chemicals": 1 }, base: { "CrudeOil": 0.5417 } },
      "SubmachineGuns": { output: 3, cycle: 12, inputs: { "Plastics": 10, "Rubber": 10 }, base: { "CrudeOil": 1.6111, "Wood": 0.8889 } },
      "FieldHowitzer": { output: 1, cycle: 5, inputs: { "Steel": 10, "Rubber": 10 }, base: { "Coal": 3.5, "CrudeOil": 1.5, "Iron": 3.5 } },
      "MediumTank": { output: 1, cycle: 8, inputs: { "Steel": 15, "Rubber": 15 }, base: { "Coal": 5.25, "CrudeOil": 2.25, "Iron": 5.25 } },
      "Cruiser": { output: 1, cycle: 60, inputs: { "Steel": 100, "Rubber": 100 }, base: { "Coal": 35, "CrudeOil": 15, "Iron": 35 } },
      "LightFighter": { output: 1, cycle: 10, inputs: { "Rubber": 20, "Plastics": 20 }, base: { "CrudeOil": 9.6667, "Wood": 5.3333 } },
      "LightBomber": { output: 1, cycle: 18, inputs: { "Steel": 30, "AluminumSheets": 20, "Rubber": 20 }, base: { "Aluminum": 8, "Coal": 10.5, "CrudeOil": 4.3333, "Iron": 10.5 } },
      "Quartz": { output: 10, cycle: 12, inputs: null, base: { "Quartz": 1 } },
      "Glass": { output: 3, cycle: 12, inputs: { "Quartz": 10, "NaturalGas": 4 }, base: { "CrudeOil": 0.3333, "Quartz": 3.3333 } },
      "Grapes": { output: 12, cycle: 12, inputs: null, base: { "Grapes": 1 } },
      "Wine": { output: 3, cycle: 12, inputs: { "Grapes": 10 }, base: { "Grapes": 3.3333 } },
      "Gold": { output: 4, cycle: 12, inputs: null, base: { "Gold": 1 } },
      "Jewelry": { output: 2, cycle: 12, inputs: { "Gold": 3, "Silver": 5 }, base: { "Galena": 2.0833, "Gold": 1.5 } },
      "Algae": { output: 7, cycle: 12, inputs: null, base: { "Algae": 1 } },
      "Sushi": { output: 4, cycle: 12, inputs: { "Algae": 5, "Fish": 10 }, base: { "Algae": 1.25, "Fish": 2.5 } },
      "Pie": { output: 5, cycle: 12, inputs: { "Flour": 5, "Fruit": 3 }, base: { "Fruit": 0.6, "Grain": 0.625 } },
      "ElectricalParts": { output: 20, cycle: 12, inputs: { "Plastics": 5, "Copper": 5 }, base: { "Copper": 0.25, "CrudeOil": 0.0833, "Wood": 0.0667 } },
      "TV": { output: 2, cycle: 12, inputs: { "AluminumSheets": 5, "ElectricalParts": 15 }, base: { "Aluminum": 1, "Copper": 1.875, "CrudeOil": 0.7917, "Wood": 0.5 } },
      "Medicines": { output: 4, cycle: 12, inputs: { "Chemicals": 10 }, base: { "CrudeOil": 0.4167 } },
      "MachineGuns": { output: 2, cycle: 12, inputs: { "Plastics": 15, "Rubber": 15, "AluminumSheets": 3 }, base: { "Aluminum": 0.6, "CrudeOil": 3.725, "Wood": 2 } },
      "HeavyArtillery": { output: 1, cycle: 6, inputs: { "Steel": 15, "Rubber": 20, "ElectricalParts": 10 }, base: { "Coal": 5.25, "Copper": 2.5, "CrudeOil": 3.8333, "Iron": 5.25, "Wood": 0.6667 } },
      "HeavyTank": { output: 1, cycle: 10, inputs: { "Steel": 20, "AluminumSheets": 20, "ElectricalParts": 30 }, base: { "Aluminum": 8, "Coal": 7, "Copper": 7.5, "CrudeOil": 3.8333, "Iron": 7, "Wood": 2 } },
      "Battleship": { output: 1, cycle: 60, inputs: { "Steel": 150, "Rubber": 150, "ElectricalParts": 150 }, base: { "Coal": 52.5, "Copper": 37.5, "CrudeOil": 35, "Iron": 52.5, "Wood": 10 } },
      "HeavyFighter": { output: 1, cycle: 12, inputs: { "AluminumSheets": 30, "Rubber": 30, "ElectricalParts": 25 }, base: { "Aluminum": 12, "Copper": 6.25, "CrudeOil": 8.5833, "Wood": 1.6667 } },
      "HeavyBomber": { output: 1, cycle: 20, inputs: { "Steel": 50, "Rubber": 50, "ElectricalParts": 40 }, base: { "Coal": 17.5, "Copper": 10, "CrudeOil": 10.8333, "Iron": 17.5, "Wood": 2.6667 } },
      "Bombs": { output: 3, cycle: 12, inputs: { "Chemicals": 1, "Steel": 1 }, base: { "Coal": 0.1167, "CrudeOil": 0.0556, "Iron": 0.1167 } },
      "ElectricityCoal": { output: 200, cycle: 12, inputs: { "Coal": 1 }, base: { "Electricity": 1 } },
      "ElectricityDiesel": { output: 500, cycle: 12, inputs: { "Diesel": 2 }, base: { "Electricity": 1 } },
      "ElectricityGas": { output: 1000, cycle: 12, inputs: { "NaturalGas": 2 }, base: { "Electricity": 1 } },
      "Water": { output: 300, cycle: 12, inputs: null, base: { "Water": 1 } },
      "ElectricityWind": { output: 25, cycle: 12, inputs: null, base: { "Electricity": 1 } },
      "WaterDesalination": { output: 750, cycle: 12, inputs: null, base: { "Water": 1 } }
    };
    const buildings = {
      "Farm": { produces: ["Vegetables"], cash: 100, upkeep: 120.0, workforce: 10, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "GrainField": { produces: ["Grain"], cash: 100, upkeep: 168.0, workforce: 10, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "FlourMill": { produces: ["Flour"], cash: 600, upkeep: 480.0, workforce: 30, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "Bakery": { produces: ["Bread", "Pie"], cash: 600, upkeep: 600.0, workforce: 30, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "Forester": { produces: ["Wood"], cash: 150, upkeep: 216.0, workforce: 10, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "CelluloseFactory": { produces: ["Cellulose"], cash: 400, upkeep: 600.0, workforce: 20, workforcetype: "Laborers", electricity: 10.0, water: 0.0 },
      "LumberYard": { produces: ["Plywood", "Lumber"], cash: 300, upkeep: 480.0, workforce: 10, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "IronMine": { produces: ["Iron"], cash: 250, upkeep: 600.0, workforce: 10, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "CoalMine": { produces: ["Coal"], cash: 600, upkeep: 480.0, workforce: 30, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "Smelter": { produces: ["Steel", "Brass", "Lead", "Silver"], cash: 250, upkeep: 840.0, workforce: 10, workforcetype: "Laborers", electricity: 10.0, water: 0.0 },
      "CottonField": { produces: ["Cotton"], cash: 200, upkeep: 240.0, workforce: 20, workforcetype: "Laborers", electricity: 0.0, water: 5.0 },
      "Weaver": { produces: ["Cloth", "SilkCloth"], cash: 250, upkeep: 480.0, workforce: 10, workforcetype: "Laborers", electricity: 15.0, water: 0.0 },
      "Clothier": { produces: ["Clothes", "FineGarments"], cash: 250, upkeep: 480.0, workforce: 10, workforcetype: "Laborers", electricity: 10.0, water: 0.0 },
      "CopperMine": { produces: ["Copper"], cash: 600, upkeep: 600.0, workforce: 30, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "ZincMine": { produces: ["Zinc"], cash: 600, upkeep: 600.0, workforce: 30, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "ClayPit": { produces: ["Clay"], cash: 1000, upkeep: 1320.0, workforce: 40, workforcetype: "Laborers", electricity: 0.0, water: 5.0 },
      "Brickworks": { produces: ["Bricks"], cash: 1000, upkeep: 1680.0, workforce: 40, workforcetype: "Laborers", electricity: 10.0, water: 10.0 },
      "PaperMill": { produces: ["Paper"], cash: 400, upkeep: 840.0, workforce: 20, workforcetype: "Laborers", electricity: 5.0, water: 0.0 },
      "PrintingPress": { produces: ["Newspapers"], cash: 800, upkeep: 1320.0, workforce: 20, workforcetype: "Laborers", electricity: 15.0, water: 0.0 },
      "OilPump": { produces: ["CrudeOil"], cash: 1000, upkeep: 1560.0, workforce: 40, workforcetype: "Laborers", electricity: 0.0, water: 5.0 },
      "DesalinationPlant": { produces: ["WaterDesalination"], cash: 2750, upkeep: 4320.0, workforce: 25, workforcetype: "Technicians", electricity: 40.0, water: 0.0 },
      "Refinery": { produces: ["Diesel", "Rubber", "Chemicals", "NaturalGas", "Kerosene"], cash: 1000, upkeep: 1920.0, workforce: 20, workforcetype: "Manufacturers", electricity: 10.0, water: 40.0 },
      "Brewery": { produces: ["Ale"], cash: 500, upkeep: 1080.0, workforce: 10, workforcetype: "Laborers", electricity: 5.0, water: 25.0 },
      "Ranch": { produces: ["Meat"], cash: 1000, upkeep: 1440.0, workforce: 40, workforcetype: "Laborers", electricity: 0.0, water: 20.0 },
      "Fishery": { produces: ["Fish"], cash: 1000, upkeep: 960.0, workforce: 40, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "GalenaExtractor": { produces: ["Galena"], cash: 2500, upkeep: 2160.0, workforce: 70, workforcetype: "Laborers", electricity: 5.0, water: 0.0 },
      "SoupKitchen": { produces: ["FishSoup"], cash: 1500, upkeep: 2640.0, workforce: 25, workforcetype: "Manufacturers", electricity: 10.0, water: 30.0 },
      "Orchard": { produces: ["Fruit"], cash: 2000, upkeep: 3240.0, workforce: 70, workforcetype: "Laborers", electricity: 0.0, water: 60.0 },
      "Juicery": { produces: ["Juice"], cash: 2000, upkeep: 3360.0, workforce: 35, workforcetype: "Manufacturers", electricity: 30.0, water: 50.0 },
      "LimestoneQuarry": { produces: ["Limestone"], cash: 3000, upkeep: 1800.0, workforce: 80, workforcetype: "Laborers", electricity: 20.0, water: 0.0 },
      "CementFactory": { produces: ["Cement"], cash: 3000, upkeep: 3240.0, workforce: 40, workforcetype: "Manufacturers", electricity: 30.0, water: 40.0 },
      "GravelPit": { produces: ["Gravel"], cash: 500, upkeep: 1080.0, workforce: 20, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "ConcreteMixer": { produces: ["Concrete"], cash: 3000, upkeep: 3840.0, workforce: 25, workforcetype: "Technicians", electricity: 90.0, water: 60.0 },
      "PlasticsFactory": { produces: ["Plastics"], cash: 2000, upkeep: 3840.0, workforce: 30, workforcetype: "Manufacturers", electricity: 40.0, water: 20.0 },
      "AppliancesFactory": { produces: ["Gramophone", "Telephone", "Radio", "TV"], cash: 1200, upkeep: 2160.0, workforce: 30, workforcetype: "Laborers", electricity: 20.0, water: 20.0 },
      "SilkwormHatchery": { produces: ["Silk"], cash: 3000, upkeep: 3480.0, workforce: 60, workforcetype: "Laborers", electricity: 5.0, water: 30.0 },
      "DyeFactory": { produces: ["Dye"], cash: 3000, upkeep: 3480.0, workforce: 30, workforcetype: "Manufacturers", electricity: 20.0, water: 60.0 },
      "AluminumMine": { produces: ["Aluminum"], cash: 3000, upkeep: 3240.0, workforce: 40, workforcetype: "Manufacturers", electricity: 15.0, water: 0.0 },
      "AluminumMill": { produces: ["AluminumSheets"], cash: 3000, upkeep: 3840.0, workforce: 25, workforcetype: "Technicians", electricity: 75.0, water: 0.0 },
      "Cannery": { produces: ["CannedMeat"], cash: 4500, upkeep: 3960.0, workforce: 40, workforcetype: "Technicians", electricity: 40.0, water: 20.0 },
      "QuartzMine": { produces: ["Quartz"], cash: 4500, upkeep: 1680.0, workforce: 110, workforcetype: "Laborers", electricity: 10.0, water: 0.0 },
      "Glassworks": { produces: ["Glass"], cash: 4500, upkeep: 4320.0, workforce: 30, workforcetype: "Specialists", electricity: 50.0, water: 50.0 },
      "Vineyard": { produces: ["Grapes"], cash: 3500, upkeep: 3720.0, workforce: 40, workforcetype: "Specialists", electricity: 5.0, water: 20.0 },
      "Distillery": { produces: ["Wine"], cash: 4500, upkeep: 5400.0, workforce: 30, workforcetype: "Technicians", electricity: 10.0, water: 75.0 },
      "GoldMine": { produces: ["Gold"], cash: 5000, upkeep: 3240.0, workforce: 100, workforcetype: "Laborers", electricity: 40.0, water: 0.0 },
      "Jeweler": { produces: ["Jewelry"], cash: 5000, upkeep: 6480.0, workforce: 25, workforcetype: "Specialists", electricity: 20.0, water: 10.0 },
      "AlgaeFarm": { produces: ["Algae"], cash: 3000, upkeep: 3840.0, workforce: 30, workforcetype: "Technicians", electricity: 15.0, water: 10.0 },
      "SushiBar": { produces: ["Sushi"], cash: 3000, upkeep: 4800.0, workforce: 30, workforcetype: "Technicians", electricity: 20.0, water: 30.0 },
      "ElectricFactory": { produces: ["ElectricalParts"], cash: 5000, upkeep: 6480.0, workforce: 30, workforcetype: "Specialists", electricity: 100.0, water: 0.0 },
      "Pharmacology": { produces: ["Medicines"], cash: 5500, upkeep: 9600.0, workforce: 75, workforcetype: "Specialists", electricity: 80.0, water: 60.0 },
      "MunitionsFactory": { produces: ["Ammunition", "ArtilleryShells", "Bombs"], cash: 750, upkeep: 1440.0, workforce: 50, workforcetype: "Manufacturers", electricity: 3.0, water: 0.0 },
      "Factory": { produces: ["FoodRations", "ArmyRations", "Handguns", "Rifles", "SubmachineGuns", "MachineGuns"], cash: 750, upkeep: 1200.0, workforce: 50, workforcetype: "Manufacturers", electricity: 5.0, water: 0.0 },
      "TankFactory": { produces: ["FieldGun", "PounderGun", "FieldHowitzer", "HeavyArtillery", "InfantryTank", "LightTank", "MediumTank", "HeavyTank"], cash: 1500, upkeep: 2400.0, workforce: 75, workforcetype: "Manufacturers", electricity: 15.0, water: 0.0 },
      "AircraftFactory": { produces: ["ReconBiplane", "FighterTriplane", "LightFighter", "HeavyFighter", "Blimp", "Airship", "LightBomber", "HeavyBomber"], cash: 3500, upkeep: 3840.0, workforce: 60, workforcetype: "Technicians", electricity: 50.0, water: 10.0 },
      "Shipyard": { produces: ["Corvette", "Destroyer", "Cruiser", "Battleship"], cash: 2500, upkeep: 5400.0, workforce: 100, workforcetype: "Manufacturers", electricity: 35.0, water: 0.0 },
      "Depot": { produces: [""], cash: 400, upkeep: 600.0, workforce: 8, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "Warehouse": { produces: [""], cash: 1500, upkeep: 2160.0, workforce: 25, workforcetype: "Manufacturers", electricity: 40.0, water: 10.0 },
      "TradePort": { produces: [""], cash: 2000, upkeep: 4320.0, workforce: 30, workforcetype: "Manufacturers", electricity: 40.0, water: 15.0 },
      "Airport": { produces: [""], cash: 5500, upkeep: 6480.0, workforce: 35, workforcetype: "Specialists", electricity: 100.0, water: 40.0 },
      "CoalPowerPlant": { produces: ["ElectricityCoal"], cash: 1500, upkeep: 1800.0, workforce: 25, workforcetype: "Manufacturers", electricity: 0.0, water: 0.0 },
      "PowerSubstation": { produces: [""], cash: 100, upkeep: 120.0, workforce: 1, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "WaterPump": { produces: ["Water"], cash: 250, upkeep: 840.0, workforce: 5, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "DieselPowerPlant": { produces: ["ElectricityDiesel"], cash: 2500, upkeep: 2760.0, workforce: 30, workforcetype: "Manufacturers", electricity: 0.0, water: 0.0 },
      "NaturalGasPowerPlant": { produces: ["ElectricityGas"], cash: 1500, upkeep: 3960.0, workforce: 30, workforcetype: "Specialists", electricity: 0.0, water: 0.0 },
      "FireStation": { produces: [""], cash: 500, upkeep: 1080.0, workforce: 10, workforcetype: "Laborers", electricity: 5.0, water: 0.0 },
      "PoliceStation": { produces: [""], cash: 1500, upkeep: 1800.0, workforce: 30, workforcetype: "Laborers", electricity: 10.0, water: 0.0 },
      "ElementarySchool": { produces: [""], cash: 1000, upkeep: 1440.0, workforce: 20, workforcetype: "Laborers", electricity: 5.0, water: 0.0 },
      "Highschool": { produces: [""], cash: 2500, upkeep: 2160.0, workforce: 20, workforcetype: "Manufacturers", electricity: 10.0, water: 30.0 },
      "University": { produces: [""], cash: 5000, upkeep: 4320.0, workforce: 40, workforcetype: "Specialists", electricity: 40.0, water: 50.0 },
      "ResearchCenter": { produces: [""], cash: 6500, upkeep: 9720.0, workforce: 120, workforcetype: "Specialists", electricity: 150.0, water: 100.0 },
      "Clinic": { produces: [""], cash: 2000, upkeep: 1560.0, workforce: 20, workforcetype: "Manufacturers", electricity: 10.0, water: 30.0 },
      "Hospital": { produces: [""], cash: 3500, upkeep: 3240.0, workforce: 30, workforcetype: "Technicians", electricity: 50.0, water: 60.0 },
      "Courthouse": { produces: [""], cash: 4000, upkeep: 6480.0, workforce: 40, workforcetype: "Technicians", electricity: 40.0, water: 30.0 },
      "Prison": { produces: [""], cash: 3000, upkeep: 4320.0, workforce: 20, workforcetype: "Technicians", electricity: 15.0, water: 0.0 },
      "MilitaryBase": { produces: [""], cash: 1000, upkeep: 0.0, workforce: 0, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "NavalBase": { produces: [""], cash: 5000, upkeep: 0.0, workforce: 0, workforcetype: "Manufacturers", electricity: 15.0, water: 0.0 },
      "Airbase": { produces: [""], cash: 7500, upkeep: 0.0, workforce: 0, workforcetype: "Technicians", electricity: 35.0, water: 0.0 },
      "RecordLabel": { produces: [""], cash: 2000, upkeep: 2160.0, workforce: 20, workforcetype: "Manufacturers", electricity: 10.0, water: 15.0 },
      "RadioStation": { produces: [""], cash: 2500, upkeep: 4320.0, workforce: 20, workforcetype: "Technicians", electricity: 50.0, water: 15.0 },
      "TVStation": { produces: [""], cash: 6000, upkeep: 6480.0, workforce: 30, workforcetype: "Specialists", electricity: 100.0, water: 20.0 },
      "JazzClub": { produces: [""], cash: 6500, upkeep: 8640.0, workforce: 35, workforcetype: "Specialists", electricity: 90.0, water: 60.0 },
      "HouseLowDensity1": { produces: [""], cash: 0, upkeep: 0.0, workforce: 30, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "HouseLowDensity2": { produces: [""], cash: 0, upkeep: 0.0, workforce: 30, workforcetype: "Manufacturers", electricity: 0.0, water: 0.2 },
      "HouseLowDensity3": { produces: [""], cash: 0, upkeep: 0.0, workforce: 30, workforcetype: "Technicians", electricity: 0.5, water: 0.4 },
      "HouseLowDensity4": { produces: [""], cash: 0, upkeep: 0.0, workforce: 30, workforcetype: "Specialists", electricity: 1.0, water: 0.4 },
      "HouseHighDensity1": { produces: [""], cash: 0, upkeep: 0.0, workforce: 80, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "HouseHighDensity2": { produces: [""], cash: 0, upkeep: 0.0, workforce: 80, workforcetype: "Manufacturers", electricity: 0.0, water: 0.2 },
      "HouseHighDensity3": { produces: [""], cash: 0, upkeep: 0.0, workforce: 80, workforcetype: "Technicians", electricity: 0.5, water: 0.4 },
      "HouseHighDensity4": { produces: [""], cash: 0, upkeep: 0.0, workforce: 80, workforcetype: "Specialists", electricity: 1.0, water: 0.6 },
      "TownCenter": { produces: [""], cash: 0, upkeep: 0.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Windmill": { produces: ["ElectricityWind"], cash: 200, upkeep: 240.0, workforce: 3, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "Market": { produces: [""], cash: 1000, upkeep: 1680.0, workforce: 15, workforcetype: "Laborers", electricity: 15.0, water: 0.0 },
      "WaterTower": { produces: [""], cash: 150, upkeep: 120.0, workforce: 1, workforcetype: "Laborers", electricity: 0.0, water: 0.0 },
      "LawnT1": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "LawnT2": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PlazaT1": { produces: [""], cash: 0, upkeep: 48.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PlazaT2": { produces: [""], cash: 0, upkeep: 48.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PlazaT3": { produces: [""], cash: 0, upkeep: 48.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PlazaT4": { produces: [""], cash: 0, upkeep: 48.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park1": { produces: [""], cash: 0, upkeep: 216.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park2": { produces: [""], cash: 0, upkeep: 216.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park3": { produces: [""], cash: 0, upkeep: 216.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park4": { produces: [""], cash: 0, upkeep: 480.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park5": { produces: [""], cash: 0, upkeep: 480.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park6": { produces: [""], cash: 0, upkeep: 600.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park7": { produces: [""], cash: 0, upkeep: 1080.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "TreeT1": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "TreeT2": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "TreeT3": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "TreeT4": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "HedgeT1": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "HedgeT2": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "HedgeT3": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "HedgeT4": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "FenceT1": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "FenceT2": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "FenceT3": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "FenceT4": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PondT1": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PondT2": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PondT3": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "PondT4": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "DirtRoad": { produces: [""], cash: 0, upkeep: 0.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Quay": { produces: [""], cash: 0, upkeep: 0.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "LawnT3": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "LawnT4": { produces: [""], cash: 0, upkeep: 24.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "GravelRoad": { produces: [""], cash: 0, upkeep: 0.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "AsphaltRoad": { produces: [""], cash: 0, upkeep: 0.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Tunnel": { produces: [""], cash: 0, upkeep: 0.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
      "Park8": { produces: [""], cash: 0, upkeep: 1200.0, workforce: 0, workforcetype: "None", electricity: 0.0, water: 0.0 },
    };


    // --- DOM ELEMENTS ---
    const selector = document.getElementById('productSelector');
    const amountInput = document.getElementById('amount');
    const outputDetailsDiv = document.getElementById('outputDetails');
    const buildingUpgradesDiv = document.getElementById('buildingUpgrades');
    const graphDivElement = document.getElementById('graphDiv');
    const totalsDivElement = document.getElementById('totalsDiv');
    const externalInputsDivElement = document.getElementById('externalInputsDiv');


    // --- STATE & CONSTANTS ---
    const upgradeOptions = [0, 0.2, 0.4, 0.6];
    const upkeepReductionOptions = [0, 0.12, 0.24, 0.36];
    const workforceReductionOptions = [0, 0.15, 0.30, 0.45];
    const buildingUpgradeMap = {};
    const buildingUpkeepReductionMap = {};
    const buildingWorkforceReductionMap = {};
    const workforceEmojis = { Laborers: "ðŸ§‘â€ðŸŒ¾", Manufacturers: "ðŸ­", Technicians: "ðŸ”§", Specialists: "ðŸ§ ", None: "âž–" };
    let activeBuildingSet = new Set();

    // --- INITIALIZATION ---
    function initialize() {
        // Populate product selector - using original definition order
        Object.keys(data).forEach(product => { // Removed .sort()
          const opt = document.createElement('option');
          opt.value = product;
          opt.textContent = product;
          selector.appendChild(opt);
        });

        // Set initial product and amount - using original definition order
        if (Object.keys(data).length > 0) {
            const initialProduct = Object.keys(data)[0]; // Default to the first product as defined
            selector.value = initialProduct;
            amountInput.value = data[initialProduct]?.output || 1;
        } else {
            console.error("Data object is empty!");
            outputDetailsDiv.innerHTML = "Error: Product data is missing.";
            return;
        }

        // Add event listeners
        selector.addEventListener('change', handleSelectionChange);
        amountInput.addEventListener('input', debounce(display, 300));

        // Initial display
        display();
    }

    // Updated handleSelectionChange to always reset amount
    function handleSelectionChange() {
        const selectedProduct = selector.value;
        const defaultAmount = data[selectedProduct]?.output || 1; // Get the default amount for the NEW product

        console.log(`Product changed to: ${selectedProduct}. Setting Amount Input to default: ${defaultAmount}`);

        // Explicitly set the input field's value
        amountInput.value = defaultAmount;

        // Call display AFTER setting the value. Display will read the new value.
        display();
    }

    // --- Helper function for formatting numbers ---
    function formatNumber(num, precision = 4) { if (typeof num !== 'number' || isNaN(num)) return num; return parseFloat(num.toFixed(precision)); }

    // --- CORE CALCULATION LOGIC ---
    function calculateAllBackward(targetProductName, targetOutput, boostMap) {
        const integerBuildingCounts = {}; const integerProductNeeds = {}; const integerProductOutput = {}; const buildingSet = new Set();
        const demandAggregation = new Map(); demandAggregation.set(targetProductName, targetOutput);
        const processingQueue = [targetProductName]; const visitedForQueueing = new Set([targetProductName]);
        let head = 0;
        while (head < processingQueue.length) {
            const prodName = processingQueue[head++]; const currentNeeded = demandAggregation.get(prodName) || 0;
            if (currentNeeded <= 1e-9) continue; integerProductNeeds[prodName] = currentNeeded;
            const product = data[prodName]; if (!product) continue;
            const buildingInfo = Object.entries(buildings).find(([, def]) => def.produces?.includes(prodName)); if (!buildingInfo) continue;
            const [buildingName, buildingDef] = buildingInfo; buildingSet.add(buildingName);
            const boost = boostMap[prodName] || 0; const rawBoosted = product.output * (1 + boost); const outputPerFacility = Math.ceil(rawBoosted);
            if (outputPerFacility <= 1e-9) continue; const facilitiesInt = Math.ceil(currentNeeded / outputPerFacility);
            integerProductOutput[prodName] = facilitiesInt * outputPerFacility;
            integerBuildingCounts[buildingName] = Math.max(integerBuildingCounts[buildingName] || 0, facilitiesInt);
            if (product.inputs) {
                for (const [inputName, inputAmount] of Object.entries(product.inputs)) {
                    const inputDemand = facilitiesInt * inputAmount;
                    if (inputDemand > 1e-9) {
                        const existingDemand = demandAggregation.get(inputName) || 0; demandAggregation.set(inputName, existingDemand + inputDemand);
                        if (!visitedForQueueing.has(inputName)) { processingQueue.push(inputName); visitedForQueueing.add(inputName); }
                    }
                }
            }
        }
        const finalUsedBuildings = Object.keys(integerBuildingCounts).filter(bName => integerBuildingCounts[bName] > 0);
        const sortedBuildingList = Array.from(finalUsedBuildings).sort();
        return { buildingsNeeded: integerBuildingCounts, usedBuildings: sortedBuildingList, productBoostMap: boostMap, integerProductNeeds: integerProductNeeds, integerProductOutput: integerProductOutput };
    }

    // --- MERMAID GRAPH GENERATION ---
    function generateMermaidGraph(intCounts, intNeeds, boostMap) {
         let mermaidDef = "graph TD;\n"; const nodeDefs = new Map(); const edgeDefs = new Set(); const processedEdges = new Set();
         const createNodeId = (name, typePrefix = "P") => `${typePrefix}_${name.replace(/[^a-zA-Z0-9_]/g, '_')}`;
         Object.entries(intNeeds).forEach(([prodName, neededAmount]) => {
            if (neededAmount <= 1e-9) return; const prodId = createNodeId(prodName, "P");
            if (!nodeDefs.has(prodId)) { nodeDefs.set(prodId, `${prodId}("${prodName}<br/>Need: ${formatNumber(neededAmount, 1)}");`); }
         });
         Object.entries(intCounts).forEach(([buildingName, count]) => {
             if (count <= 0) return; const buildingId = createNodeId(buildingName, "B");
             if (!nodeDefs.has(buildingId)) { nodeDefs.set(buildingId, `${buildingId}("${buildingName} (x${count})");`); }
         });
         Object.entries(intNeeds).forEach(([prodName, neededAmount]) => {
              if (neededAmount <= 1e-9) return;
             const prodId = createNodeId(prodName, "P"); const productInfo = data[prodName];
             const buildingInfo = Object.entries(buildings).find(([, def]) => def.produces?.includes(prodName));
             if (buildingInfo) {
                  const [buildingName, ] = buildingInfo; const buildingCount = intCounts[buildingName] || 0; if (buildingCount <=0) return;
                  const buildingId = createNodeId(buildingName, "B");
                  const boost = boostMap[prodName] || 0; const outputPerFac = Math.ceil((productInfo?.output || 0) * (1 + boost));
                  const totalOutput = buildingCount * outputPerFac; const edgeKeyBtoP = `${buildingId}->${prodId}`;
                  if (!processedEdges.has(edgeKeyBtoP)) { edgeDefs.add(`${buildingId} -- Produces ${formatNumber(totalOutput, 1)} --> ${prodId};`); processedEdges.add(edgeKeyBtoP); }
                  if (productInfo?.inputs) {
                       const facilitiesForThisStep = Math.ceil(neededAmount / outputPerFac);
                       Object.entries(productInfo.inputs).forEach(([inputName, inputAmount]) => {
                           const inputProdId = createNodeId(inputName, "P"); const inputNeededForStep = facilitiesForThisStep * inputAmount;
                           if (nodeDefs.has(inputProdId)) {
                               const edgeKeyPtoB = `${inputProdId}->${buildingId}`;
                               if (!processedEdges.has(edgeKeyPtoB)) { edgeDefs.add(`${inputProdId} -- Consumed ${formatNumber(inputNeededForStep, 1)} --> ${buildingId};`); processedEdges.add(edgeKeyPtoB); }
                           } else { console.warn(`Graph: Input node ${inputName} not found.`); }
                       });
                  }
             }
         });
         mermaidDef += Array.from(nodeDefs.values()).join("\n") + "\n"; mermaidDef += Array.from(edgeDefs).join("\n") + "\n";
         return mermaidDef;
     }

    // --- DISPLAY LOGIC ---
    async function display() {
      const selectedProduct = selector.value; const targetOutput = parseFloat(amountInput.value) || 0;
      if (!selectedProduct || targetOutput <= 0 || !data[selectedProduct]) {
          outputDetailsDiv.innerHTML = "Please select a valid product and enter a target output > 0.";
          totalsDivElement.innerHTML = ""; externalInputsDivElement.innerHTML = ""; buildingUpgradesDiv.innerHTML = '';
          graphDivElement.innerHTML = '<p style="text-align: center; color: #888; margin-top: 2em;">Calculation error or invalid input.</p>'; activeBuildingSet.clear(); return;
      }
      const currentProductBoostMap = {};
      for (const [buildingName, def] of Object.entries(buildings)) { const boost = buildingUpgradeMap[buildingName] || 0; (def.produces || []).forEach(prod => { currentProductBoostMap[prod] = boost; }); }
      const { buildingsNeeded: integerBuildingCounts, usedBuildings, productBoostMap, integerProductNeeds, integerProductOutput } = calculateAllBackward(selectedProduct, targetOutput, currentProductBoostMap);
      const usedBuildingsSet = new Set(usedBuildings);
      if (!setsAreEqual(activeBuildingSet, usedBuildingsSet)) { activeBuildingSet = usedBuildingsSet; createBuildingUpgradeSelectors(usedBuildings); }

      // --- Generate HTML for Center Column (#outputDetails) ---
      let htmlCenter = '';
      //htmlCenter += `<div><span class="label">Product:</span> ${selectedProduct}</div>`; htmlCenter += `<div><span class="label">Target Output:</span> ${formatNumber(targetOutput, 3)} / cycle</div>`;
      const selectedProductData = data[selectedProduct]; const buildingInfoFinal = Object.entries(buildings).find(([, def]) => def.produces?.includes(selectedProduct));
      if (selectedProductData && buildingInfoFinal) {
            const [buildingNameFinal, ] = buildingInfoFinal; const boostFinal = currentProductBoostMap[selectedProduct] || 0; const outputPerFacilityFinal = Math.ceil(selectedProductData.output * (1 + boostFinal));
            const facilitiesForFinalStep = Math.ceil(targetOutput / outputPerFacilityFinal); const finalBuildingCountDisplay = integerBuildingCounts[buildingNameFinal] || 0;
            htmlCenter += `<div class="highlight-recipe">`; htmlCenter += `<div class="label">Recipe for ${selectedProduct}:</div>`; htmlCenter += `<ul>`;
            htmlCenter += `<li>Target: ${formatNumber(targetOutput, 3)}</li>`; htmlCenter += `<li>Building: ${buildingNameFinal} (Requires ${facilitiesForFinalStep} for this step, Total Used: ${finalBuildingCountDisplay})</li>`;
            htmlCenter += `<li>Output per Facility (Boosted & Rounded): ${outputPerFacilityFinal}</li>`;
            if (selectedProductData.inputs) {
                htmlCenter += `<li>Inputs Required (per Facility):</li><ul>`;
                Object.entries(selectedProductData.inputs).forEach(([inputName, amountPerFac]) => { const totalInputNeeded = facilitiesForFinalStep * amountPerFac; htmlCenter += `<li>${inputName}: ${formatNumber(amountPerFac, 3)} (Total needed for this step: ${formatNumber(totalInputNeeded, 3)})</li>`; });
                htmlCenter += `</ul>`;
            } else { htmlCenter += `<li>Inputs Required: None (Base Resource)</li>`; }
            htmlCenter += `</ul>`; htmlCenter += `</div>`;
      } else if (selectedProductData && !selectedProductData.inputs) {
           htmlCenter += `<div class="highlight-recipe">`; htmlCenter += `<div class="label">${selectedProduct} is a Base Resource.</div>`; htmlCenter += `<ul><li>Total Needed: ${formatNumber(targetOutput, 3)}</li></ul>`; htmlCenter += `</div>`;
      }
      htmlCenter += `<div><span class="label">Full Chain Steps (Detailed Demand & Output):</span><ul>`;
      const productSteps = Array.from(Object.keys(integerProductNeeds)).sort((a,b) => a.localeCompare(b));
       productSteps.forEach(productName => {
          const needed = integerProductNeeds[productName] || 0; if (needed <= 1e-9) return;
          const actualOutput = integerProductOutput[productName] || 0; const productInfo = data[productName]; if (!productInfo) return;
          const buildingInfo = Object.entries(buildings).find(([, def]) => def.produces?.includes(productName)); const buildingName = buildingInfo ? buildingInfo[0] : null;
          const count = buildingName ? (integerBuildingCounts[buildingName] || 0) : 0; const boost = productBoostMap[productName] || 0;
          const rawBoosted = productInfo.output * (1 + boost); const outputPerFacility = Math.ceil(rawBoosted); let line = `<li>${productName}: Demand ${formatNumber(needed, 3)}.`;
          if (buildingInfo) {
               const facilitiesForThisStep = Math.ceil(needed / outputPerFacility); const outputForThisStep = facilitiesForThisStep * outputPerFacility;
               line += ` Use ${count} ${buildingName}(s). Est. Output (from ${facilitiesForThisStep} needed): ${formatNumber(outputForThisStep, 3)} (@ ${outputPerFacility}/fac).`;
               if (productInfo.inputs && facilitiesForThisStep > 0) { const inputNeedsStr = Object.entries(productInfo.inputs) .map(([i, v]) => `${formatNumber(facilitiesForThisStep * v, 3)} ${i}`) .join(', '); line += ` Needs Inputs: ${inputNeedsStr}.`; }
          } else { line += " (Base Resource)"; } htmlCenter += line + `</li>`;
      }); htmlCenter += `</ul></div>`;
       htmlCenter += `<div><span class="label">Buildings Required (Total Integer):</span><ul>`;
       let totals = { cash: 0, upkeep: 0, power: 0, water: 0 }; let workforce = {}; // Calculate totals while building this list
       Object.entries(integerBuildingCounts) .sort(([bA], [bB]) => bA.localeCompare(bB)) .forEach(([buildingName, count]) => {
            if (count <= 0) return; const def = buildings[buildingName]; if (!def) { console.warn(`Missing def for ${buildingName}`); return; }
            const upkeepRed = buildingUpkeepReductionMap[buildingName] || 0; const workforceRed = buildingWorkforceReductionMap[buildingName] || 0;
            const totalCash = (def.cash || 0) * count; const totalUpkeep = (def.upkeep || 0) * (1 - upkeepRed) * count; const totalWorkforce = (def.workforce || 0) * (1 - workforceRed) * count;
            const totalPower = (def.electricity || 0) * count; const totalWater = (def.water || 0) * count;
            totals.cash += totalCash; totals.upkeep += totalUpkeep; totals.power += totalPower; totals.water += totalWater;
            const wfType = def.workforcetype || 'None'; if (wfType !== 'None' && totalWorkforce > 1e-9) { workforce[wfType] = (workforce[wfType] || 0) + totalWorkforce; }
            let details = `ðŸ’°${totalCash.toFixed(0)} | ðŸ§¾${totalUpkeep.toFixed(1)}/d`;
            if (totalWorkforce > 1e-9) { details += ` | ${workforceEmojis[wfType] || 'â“'} ${formatNumber(totalWorkforce, 2)} ${wfType}`; } else if (def.workforce > 0) { details += ` | ${workforceEmojis[wfType] || 'â“'} 0 ${wfType}`; }
            if (totalPower > 1e-9) details += ` | âš¡${formatNumber(totalPower, 2)}`; if (totalWater > 1e-9) details += ` | ðŸ’§${formatNumber(totalWater, 2)}`;
            htmlCenter += `<li>${buildingName}: ${count}x â€” ${details}</li>`;
       }); htmlCenter += `</ul></div>`;
      outputDetailsDiv.innerHTML = htmlCenter;

      // --- Generate HTML for Left Column: Totals (#totalsDiv) ---
      let htmlTotals = `<div class="label">Grand Totals:</div><ul>`;
      htmlTotals += `<li>ðŸ’° Total Build Cost: $${totals.cash.toFixed(0)}</li>`; htmlTotals += `<li>ðŸ§¾ Total Daily Upkeep: $${totals.upkeep.toFixed(1)}</li>`;
      htmlTotals += `<li>âš¡ Total Electricity Demand: ${formatNumber(totals.power, 2)}</li>`; htmlTotals += `<li>ðŸ’§ Total Water Demand: ${formatNumber(totals.water, 2)}</li>`;
      htmlTotals += Object.entries(workforce) .sort(([typeA], [typeB]) => typeA.localeCompare(typeB)) .map(([type, amt]) => `<li>${workforceEmojis[type] || 'â“'} Total ${type}: ${formatNumber(amt, 2)}</li>`).join('');
      htmlTotals += `</ul>`;
      totalsDivElement.innerHTML = htmlTotals;

      // --- Generate HTML for Left Column: External Inputs (#externalInputsDiv) ---
      let htmlInputs = `<div class="label">ðŸ“¦ Total External Inputs Required per Cycle (Base Resources):</div><ul>`;
      const externalInputTotals = {};
      for (const [productName, neededAmount] of Object.entries(integerProductNeeds)) { const product = data[productName]; if (neededAmount > 1e-9 && !product?.inputs) { externalInputTotals[productName] = (externalInputTotals[productName] || 0) + neededAmount; } }
      const externalInputsList = Object.entries(externalInputTotals) .filter(([, amt]) => amt > 1e-9) .sort(([resA], [resB]) => resA.localeCompare(resB)) .map(([res, amt]) => `<li>${res}: ${formatNumber(amt, 4)}</li>`);
      htmlInputs += externalInputsList.join('');
      if (externalInputsList.length === 0) { if (!data[selectedProduct]?.inputs) { htmlInputs += `<li>None (Selected product is a base resource).</li>`; } else { htmlInputs += `<li>None (All base inputs seem to be met internally or not required).</li>`; } }
      htmlInputs += `</ul>`;
      externalInputsDivElement.innerHTML = htmlInputs;

      // --- Render Mermaid Graph ---
      try {
          const mermaidDefinition = generateMermaidGraph(integerBuildingCounts, integerProductNeeds, currentProductBoostMap);
          graphDivElement.innerHTML = mermaidDefinition; graphDivElement.removeAttribute('data-processed');
          await mermaid.run({ nodes: [graphDivElement] }); console.log("Mermaid rendering triggered.");
      } catch (e) { console.error("Error rendering Mermaid graph:", e); graphDivElement.innerHTML = '<p style="color: red; text-align: center;">Error generating visualization.</p>'; }
    }

    // --- UTILITIES ---
    function createBuildingUpgradeSelectors(buildingNames) {
      buildingUpgradesDiv.innerHTML = '<h3>Per-Building Upgrades</h3>'; const fragment = document.createDocumentFragment();
      buildingNames.forEach(buildingName => {
        if (!buildings[buildingName]) { return; } const row = document.createElement('div'); row.className = 'upgrade-row';
        const label = document.createElement('label'); label.textContent = `${buildingName}:`; label.htmlFor = `boost-${buildingName}`;
        const boostSelect = createSelect(upgradeOptions, buildingUpgradeMap, buildingName, value => `ðŸ­ ${Math.round(value * 100)}%`, `boost-${buildingName}`);
        const upkeepSelect = createSelect(upkeepReductionOptions, buildingUpkeepReductionMap, buildingName, value => `ðŸ§¾ -${Math.round(value * 100)}%`, `upkeep-${buildingName}`);
        const workforceSelect = createSelect(workforceReductionOptions, buildingWorkforceReductionMap, buildingName, value => `ðŸ‘· -${Math.round(value * 100)}%`, `workforce-${buildingName}`);
        row.appendChild(label); row.appendChild(boostSelect); row.appendChild(upkeepSelect); row.appendChild(workforceSelect); fragment.appendChild(row);
      }); buildingUpgradesDiv.appendChild(fragment);
      buildingNames.forEach(bName => {
           if (!(bName in buildingUpgradeMap)) buildingUpgradeMap[bName] = 0; if (!(bName in buildingUpkeepReductionMap)) buildingUpkeepReductionMap[bName] = 0; if (!(bName in buildingWorkforceReductionMap)) buildingWorkforceReductionMap[bName] = 0;
      });
    }
    function createSelect(options, map, key, labelFn, id) {
      const select = document.createElement('select'); select.id = id; if (!(key in map)) { map[key] = 0; }
      options.forEach(value => { const opt = document.createElement('option'); opt.value = value; opt.textContent = labelFn(value); if (parseFloat(value) === parseFloat(map[key])) { opt.selected = true; } select.appendChild(opt); });
      select.addEventListener('change', () => { map[key] = parseFloat(select.value); display(); }); return select;
    }
    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
    function setsAreEqual(setA, setB) { if (setA.size !== setB.size) return false; for (const item of setA) { if (!setB.has(item)) return false; } return true; }

    // --- START ---
    document.addEventListener('DOMContentLoaded', initialize);

  </script>
</body>
</html>
